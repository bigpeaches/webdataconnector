<html>
<meta http-equiv="Cache-Control" content="no-store" />
<head>
<title>Stock Quote Connector</title>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
<script src="../js/tableauwdc-1.2.0.js" type="text/javascript"></script>
<script type="text/javascript">
 (function() {

  //
  // Helper functions
  //

  // Takes a ticker symbol, a start date and an end date, and constructs a URL for the Yahoo! stock quote API
  function buildUrl(tickerSymbol, startDate, endDate) {
    var startDateStr = getDateAsString(startDate);
    var endDateStr = getDateAsString(endDate);
    var data = 'select * from yahoo.finance.historicaldata where symbol = "' + tickerSymbol + '" and startDate = "' + startDateStr 
        + '" and endDate = "' + endDateStr + '"';
    var url = 'http://query.yahooapis.com/v1/public/yql?q=' + encodeURIComponent(data) + "&env=http%3A%2F%2Fdatatables.org%2Falltables.env&format=json";
    return url;
  }

  // Gets a string representation of a date that can be used with the Yahoo! API.
  function getDateAsString(date) {
    return date.getUTCFullYear()  + '-' + makeTwoDigits(date.getUTCMonth() + 1) + '-' + makeTwoDigits(date.getUTCDate());
  }

  // Pads a given number with leading 0s so that there are two characters in the string. Example: makeTwoDigits(1) --> "01"
  function makeTwoDigits(num) {
    return num < 9 ? "0" + num.toString() : num.toString();
  }

  function getTickersArrayFromConnectionData(connectionData) {
    var tickersArray = connectionData.split(',');
    
    // Remove whitespace from each ticker string
    return tickersArray.map(function(obj) {
      return obj.trim(); 
    });
  }

  //
  // Connector definition
  // 
  var myConnector = tableau.makeConnector();

  myConnector.getSchema = function(schemaCallback) {
    var tickersArray = getTickersArrayFromConnectionData(tableau.connectionData);
    
    var schema = [];
    _.forEach(tickersArray, function(ticker) {
      var col1 = { id: "Ticker", dataType: "string"};
      var col2 = { id: "Day", dataType: "date"};
      var col3 = { id: "Close", dataType: "float"};
      var cols = [col1, col2, col3];
      
      var tableInfo = { 
        id: ticker,
        columns: cols
      };
      
      schema.push(tableInfo);
    });
   
    schemaCallback(schema); // tell tableau about the fields and their types
  };
   
  myConnector.getData = function(tables, doneCallback) {
    var endDate = new Date();
    var startDate = new Date();
    // set the start of the range to be 1 year ago
    startDate.setYear(endDate.getFullYear() - 1);
    
    var promises = [];
    _.forEach(Object.keys(tables.getTables()), function(key) {
      var connectionUrl = buildUrl(key, startDate, endDate);
      promises.push(makeAPIRequest(tables, key, key, connectionUrl)); // Key and ticker are the same
    });
    
    Promise.all(promises).then(function(response) {
        console.log("Success");
        doneCallback();
    }, function(error) {
        console.error(error);
    });
  };

  function makeAPIRequest(tables, key, ticker, connectionUrl) {
    return new Promise(function(resolve, refject) {
    var xhr = $.ajax({
        url: connectionUrl,
        dataType: 'json',
        success: function (data) {
            if (data.query.results) {
              var quotes = data.query.results.quote;
              var ii;
              var toRet = [];
              // mash the data into an array of objects
              for (ii = 0; ii < quotes.length; ++ii) {
                  // Each entry can be a list of values in the same order as the columns
                  //var entry = [quotes[ii].Symbol, quotes[ii].Date, quotes[ii].Close];
                  // or an object where the column names are the keys of the map
                  var entry = {'Ticker': quotes[ii].Symbol, 
                               'Day': quotes[ii].Date, 
                               'Close': quotes[ii].Close};
                  toRet.push(entry);
              }

              tables.getTables()[key].appendRows(toRet);
              resolve();
            } else {
              reject("No results found for ticker symbol: " + ticker);
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            reject("No results found for ticker symbol: " + ticker);
        }
    });
  })
  };

  setupConnector = function() {
    var tickersString = $('#tickers').val().trim();
    if (tickersString) {
      tableau.connectionData = tickersString; // set the ticker symbol as the connection data so we can get to it when we fetch the data
      tableau.connectionName = 'Stock quotes: ' + tickersString; // name the data source. This will be the data source name in Tableau
      tableau.submit();
    }
  };

  tableau.registerConnector(myConnector);

  //
  // Setup connector UI
  //
  $(document).ready(function() {
    $("#submitButton").click(function() { // This event fires when a button is clicked
      setupConnector();
    });
    $('#tickerForm').submit(function(event) {
       event.preventDefault();
       setupConnector();
    });
  });

})();
</script>
</head>
<body>
  <div class="container container-table">
    <div class="row vertical-center-row">
       <div class="text-center col-md-4 col-md-offset-4"">
        <form role = "form" id = "tickerForm"> 
          <div class = "form-group" style = "margin: 10px;">
            <input type = "text" id = "tickers" class = "form-control" id = "name" placeholder = "Enter Multiple Stock Symbols Separated by Commas">
            <button type = "button" id = "submitButton" class = "btn btn-success" style = "margin: 10px;">Success</button>
          </div>  
        </form> 
       </div>
    </div>
  </div>

</body>
</html>

<!--
      <div>Enter a ticker symbol: <input type="text" id="ticker1" style="width: 150px;" /></div>
  <div>Enter another ticker symbol: <input type="text" id="ticker2" style="width: 150px;" /></div>
  <button type="button" id="submitButton">Get Stock Data</button>
    -->